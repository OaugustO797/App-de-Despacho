<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formatador de Despachos</title>

  <style>
    :root {
      font-family: "Inter", system-ui, -apple-system, sans-serif;
    }

    body {
      margin: 0;
      padding: 28px;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      transition: background-color 180ms ease, color 180ms ease;
    }

    body.theme-light {
      --bg-color: #f6f8fb;
      --text-color: #0f172a;
      --card-bg: #ffffff;
      --card-border: #e2e8f0;
      --muted-color: #475569;
      --error-color: #b91c1c;
      --input-bg: #f8fafc;
      --input-border: #cbd5e1;
      --button-bg: linear-gradient(135deg, #2563eb, #1d4ed8);
      --button-border: #1d4ed8;
      --button-hover-bg: linear-gradient(135deg, #1d4ed8, #1e40af);
      --button-disabled-bg: #cbd5e1;
      --button-disabled-text: #1e293b;
      --table-bg: #ffffff;
      --table-border: #e2e8f0;
      --table-header-bg: #eef2ff;
      --table-header-text: #1e3a8a;
    }

    body.theme-dark {
      color-scheme: dark;
      --bg-color: #0f172a;
      --text-color: #e2e8f0;
      --card-bg: #111827;
      --card-border: #1f2937;
      --muted-color: #94a3b8;
      --error-color: #f87171;
      --input-bg: #0b1221;
      --input-border: #1f2a40;
      --button-bg: linear-gradient(135deg, #3b82f6, #1d4ed8);
      --button-border: #1d4ed8;
      --button-hover-bg: linear-gradient(135deg, #2563eb, #1d4ed8);
      --button-disabled-bg: #334155;
      --button-disabled-text: #cbd5e1;
      --table-bg: #0b1221;
      --table-border: #1f2937;
      --table-header-bg: #1f2937;
      --table-header-text: #c7d2fe;
    }

    body.theme-matrix {
      color-scheme: dark;
      --bg-color: #020b02;
      --text-color: #c8f7c5;
      --card-bg: #051505;
      --card-border: #0f2d0f;
      --muted-color: #6baa6b;
      --error-color: #ff8a80;
      --input-bg: #031003;
      --input-border: #0f2d0f;
      --button-bg: linear-gradient(135deg, #0fd64f, #0a9b3a);
      --button-border: #0a9b3a;
      --button-hover-bg: linear-gradient(135deg, #0a9b3a, #087830);
      --button-disabled-bg: #144b1b;
      --button-disabled-text: #85c99a;
      --table-bg: #031003;
      --table-border: #0f2d0f;
      --table-header-bg: #0a1f0a;
      --table-header-text: #6cff9b;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -0.2px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 22px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08), 0 8px 18px rgba(15, 23, 42, 0.05);
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
      font-size: 15px;
    }

    input,
    textarea,
    button {
      width: 100%;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-color);
      padding: 12px 14px;
      font-size: 15px;
      transition: border-color 150ms ease, box-shadow 150ms ease, transform 150ms ease,
        background-color 150ms ease, color 150ms ease;
    }

    input:focus,
    textarea:focus,
    button:focus-visible {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
    }

    textarea {
      min-height: 240px;
      resize: vertical;
    }

    button {
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.2px;
      color: #ffffff;
      background: var(--button-bg);
      border-color: var(--button-border);
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.25);
    }

    button:hover {
      transform: translateY(-1px);
      background: var(--button-hover-bg);
      box-shadow: 0 12px 28px rgba(30, 64, 175, 0.24);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(30, 64, 175, 0.25) inset;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: var(--button-disabled-bg);
      color: var(--button-disabled-text);
      border-color: var(--button-disabled-bg);
      box-shadow: none;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 18px;
    }

    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .actions button {
      flex: 1;
      min-width: 180px;
    }

    .error {
      color: var(--error-color);
      font-weight: 700;
      margin: 12px 0 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      font-size: 14px;
      background: var(--table-bg);
      border: 1px solid var(--table-border);
      border-radius: 12px;
      overflow: hidden;
    }

    th,
    td {
      border-bottom: 1px solid var(--table-border);
      padding: 10px 12px;
      text-align: left;
    }

    th {
      background: var(--table-header-bg);
      color: var(--table-header-text);
      font-weight: 700;
      border-bottom: 1px solid var(--table-border);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .muted {
      color: var(--muted-color);
      font-size: 13px;
    }

    .theme-toggle {
      max-width: 220px;
      padding: 10px 12px;
      width: auto;
      white-space: nowrap;
    }
  </style>
</head>

<body class="theme-light">
  <div class="topbar">
    <h1>Formatador de Despachos</h1>
    <label style="margin: 0;">
      <span class="muted" style="display: block; margin-bottom: 6px;">Tema</span>
      <select id="themeSelect" class="theme-toggle">
        <option value="light">Claro</option>
        <option value="dark">Escuro</option>
        <option value="matrix">Matrix</option>
      </select>
    </label>
  </div>

  <p class="muted">
    Informe a data do turno na <strong>primeira linha</strong> (dd/mm/aaaa) e abaixo cole os registros no padrão
    <strong>HHhMM - Abertura da tela de Despacho - EMP - EXCEDIDO EM: 00%</strong>.
    O sistema detecta virada de dia, aplica +3h para SharePoint e exporta para Excel em blocos de 256 itens.
  </p>

  <div class="card">
    <label for="linhas">Data do turno + linhas de despacho</label>
    <textarea id="linhas"
      placeholder="dd/mm/aaaa&#10;18h23 - Abertura da tela de Despacho - EMP - EXCEDIDO EM: 00%"></textarea>

    <div class="actions" style="margin-top: 12px;">
      <button id="btnProcessar">Processar</button>
      <button id="btnLimpar" type="button">Limpar lista</button>
      <button id="btnCopiar" disabled>Copiar lista</button>
      <button id="btnBaixar" disabled>Baixar Excel</button>
    </div>

    <div id="erro" class="error" role="alert" aria-live="polite"></div>
    <div id="resumo" class="muted" style="margin-top: 10px;"></div>
    <div id="preview"></div>
  </div>

  <script>
    const timeSplitPattern = /\s*[-–—]\s*/;
    const timePattern = /^(?<hour>\d{1,2})[:hH](?<minute>\d{2})$/;
    const percentPattern = /(?<percent>\d{1,3})%/;
    const MAX_PER_BLOCK = 256;
    const THEME_KEY = "app-theme";
    const DAY_ROLLOVER_THRESHOLD_MINUTES = 6 * 60; // tolera pequenas reordenacoes sem criar virada de dia
    const DATE_LINE_PATTERN = /^\s*(?<day>\d{2})\/(?<month>\d{2})\/(?<year>\d{4})\s*$/;

    const HEADERS = [
      "Data",
      "Empresa",
      "Ferramenta",
      "Tipo alerta",
      "Área",
      "Observação",
    ];

    const btnProcessar = document.getElementById("btnProcessar");
    const btnLimpar = document.getElementById("btnLimpar");
    const btnBaixar = document.getElementById("btnBaixar");
    const btnCopiar = document.getElementById("btnCopiar");
    const themeSelect = document.getElementById("themeSelect");
    const preview = document.getElementById("preview");
    const erro = document.getElementById("erro");
    const resumo = document.getElementById("resumo");

    let registros = [];
    let shiftDateLabel = "";

    function applyTheme(theme) {
      const allowed = ["light", "dark", "matrix"];
      const nextTheme = allowed.includes(theme) ? theme : "light";

      document.body.classList.remove("theme-light", "theme-dark", "theme-matrix");
      document.body.classList.add(`theme-${nextTheme}`);
      localStorage.setItem(THEME_KEY, nextTheme);
      if (themeSelect) themeSelect.value = nextTheme;
    }

    function loadTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      applyTheme(stored);
    }

    // ------------------------ PARSERS ------------------------

    function parseTimePiece(piece) {
      const match = piece.trim().match(timePattern);
      if (!match) throw new Error(`Horário inválido: '${piece}'`);

      const hour = Number(match.groups.hour);
      const minute = Number(match.groups.minute);

      if (hour < 0 || hour > 23 || minute < 0 || minute > 59)
        throw new Error(`Horário fora do intervalo 00:00-23:59: '${piece}'`);

      return { hour, minute };
    }

    function parsePercent(text) {
      const match = text.match(percentPattern);
      if (!match) throw new Error(`Percentual não encontrado em: '${text}'`);

      const percent = Number(match.groups.percent);
      if (percent < 0 || percent > 100)
        throw new Error(`Percentual fora do intervalo 0-100: ${percent}`);

      return percent;
    }

    function extractExceededText(text) {
      const match = text.match(/excedido\s*em:\s*\d{1,3}%/i);
      if (match) return match[0].trim();
      return text.trim();
    }

    function parseLine(line) {
      const parts = line.split(timeSplitPattern);

      if (parts.length < 3)
        throw new Error(
          "Formato esperado: 'HHhMM - Abertura da tela de Despacho - EMP - EXCEDIDO EM: 00%'"
        );

      const timePart = parts[0].trim();
      const companyPart = parts[2].trim().toUpperCase();
      const percentPart = parts[parts.length - 1];

      const { hour, minute } = parseTimePiece(timePart);

      if (!/^[A-Z0-9]{3}$/.test(companyPart))
        throw new Error(`Empresa inválida: '${companyPart}'. Use 3 dígitos/letras.`);

      const percent = parsePercent(percentPart);

      return {
        hour,
        minute,
        company: companyPart,
        percent,
        exceededText: extractExceededText(percentPart),
      };
    }

    // ---------------------- DATA EXTRACTION ----------------------

    function extractShiftDate(lines) {
      let dateLineIndex = -1;
      let shiftDate = null;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;

        const match = line.match(DATE_LINE_PATTERN);
        if (!match) continue;

        const day = Number(match.groups.day);
        const month = Number(match.groups.month);
        const year = Number(match.groups.year);

        if (day < 1 || day > 31 || month < 1 || month > 12)
          throw new Error(`Data inválida: '${line.trim()}'`);

        shiftDate = { day, month, year };
        dateLineIndex = i;
        break;
      }

      if (!shiftDate)
        throw new Error("Informe a data na primeira linha no formato dd/mm/aaaa.");

      const remaining = lines.slice(dateLineIndex + 1);

      while (remaining.length && !remaining[0].trim()) remaining.shift();

      if (
        remaining.length &&
        remaining[0].trim().toLowerCase() === "(aqui começa a lista)"
      ) {
        remaining.shift();
      }

      return { shiftDate, remainingLines: remaining };
    }

    function formatShiftDate({ day, month, year }) {
      const d = String(day).padStart(2, "0");
      const m = String(month).padStart(2, "0");
      return `${d}/${m}/${year}`;
    }

    function parseDateLine(line) {
      const match = line.match(DATE_LINE_PATTERN);
      if (!match) return null;

      const day = Number(match.groups.day);
      const month = Number(match.groups.month);
      const year = Number(match.groups.year);

      if (day < 1 || day > 31 || month < 1 || month > 12)
        throw new Error(`Data invÇ­lida: '${line.trim()}'`);

      return { day, month, year };
    }

    // ------------------------ RECORDS ------------------------

    function buildRecords(lines, shiftDate) {
      const results = [];
      let { day: d, month: m, year: y } = shiftDate;

      let highestMinutes = null; // maior horario ja visto no dia corrente

      for (const raw of lines) {
        const line = raw.trim();
        if (!line) continue;

        // permite linhas de data no meio da lista para mudar o dia explicitamente
        const inlineDate = parseDateLine(line);
        if (inlineDate) {
          d = inlineDate.day;
          m = inlineDate.month;
          y = inlineDate.year;
          highestMinutes = null; // reseta pico ao trocar de dia manualmente
          continue;
        }

        const parsed = parseLine(line);
        const minutes = parsed.hour * 60 + parsed.minute;

        // virada de dia: hora/minuto cai muito em relacao ao maior ponto ja visto
        // tolera pequenas desordenacoes na lista sem criar novo dia
        const diffFromPeak = highestMinutes !== null ? highestMinutes - minutes : 0;
        if (
          highestMinutes !== null &&
          diffFromPeak >= DAY_ROLLOVER_THRESHOLD_MINUTES
        ) {
          const dateObj = new Date(Date.UTC(y, m - 1, d));
          dateObj.setUTCDate(dateObj.getUTCDate() + 1);

          y = dateObj.getUTCFullYear();
          m = dateObj.getUTCMonth() + 1;
          d = dateObj.getUTCDate();

          // reseta pico para novo dia
          highestMinutes = null;
        }

        const loggedAt = new Date(
          Date.UTC(y, m - 1, d, parsed.hour, parsed.minute)
        );

        results.push({
          originalLine: line,
          loggedAt,
          company: parsed.company,
          exceededPercent: parsed.percent,
          exceededText: parsed.exceededText,
        });

        highestMinutes =
          highestMinutes === null ? minutes : Math.max(highestMinutes, minutes);
      }

      return results;
    }

    function sharepointTimestamp(record) {
      const shifted = new Date(record.loggedAt.getTime() + 3 * 3600 * 1000);
      return shifted.toISOString().replace(/\.\d{3}Z$/, "Z");
    }

    function observation(r) {
      return r.exceededText;
    }

    // ------------------------ PREVIEW TABLE ------------------------

    function recordsToRows(data) {
      return data.map((r) => [
        sharepointTimestamp(r),
        r.company,
        "ELK",
        "Tela de despacho",
        "Sistemas",
        observation(r),
      ]);
    }

    function rowsToClipboardText(rows) {
      const allRows = [HEADERS, ...rows];
      return allRows.map((row) => row.join("\t")).join("\n");
    }

    // helper pra formatar data a partir de um record
    function formatRecordDate(record) {
      const d = record.loggedAt;
      const day = String(d.getUTCDate()).padStart(2, "0");
      const month = String(d.getUTCMonth() + 1).padStart(2, "0");
      const year = d.getUTCFullYear();
      return `${day}/${month}/${year}`;
    }

    // agora insere datas no meio da lista quando houver virada de dia
    function recordsToFormattedLines(data) {
      const lines = [];
      let lastDateKey = null;

      for (const record of data) {
        const d = record.loggedAt;
        const dateKey = `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, "0")}-${String(d.getUTCDate()).padStart(2, "0")}`;

        // se mudou a data (virada de dia), insere a nova data na lista
        if (lastDateKey !== null && dateKey !== lastDateKey) {
          lines.push(""); // linha em branco para separar
          lines.push(formatRecordDate(record));
          lines.push("");
        }

        if (lastDateKey === null) {
          lastDateKey = dateKey;
        } else if (dateKey !== lastDateKey) {
          lastDateKey = dateKey;
        }

        const hours = String(record.loggedAt.getUTCHours()).padStart(2, "0");
        const minutes = String(record.loggedAt.getUTCMinutes()).padStart(2, "0");

        lines.push(
          `${hours}:${minutes} - Abertura da tela de Despacho - ${record.company} - ${record.exceededText}`
        );
      }

      return lines;
    }

    async function copyText(text) {
      if (navigator.clipboard?.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          return;
        } catch (err) {
          if (err && (err.name === "NotAllowedError" || err.name === "SecurityError"))
            throw new Error("Permissão para acessar a área de transferência negada.");
        }
      }

      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.setAttribute("readonly", "");
      textarea.style.position = "absolute";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();
      textarea.setSelectionRange(0, textarea.value.length);

      const success = document.execCommand("copy");
      document.body.removeChild(textarea);

      if (!success)
        throw new Error("Não foi possível copiar para a área de transferência.");
    }

    function renderPreview(data) {
      if (!data.length) {
        preview.innerHTML = `<p class="muted">Nenhum registro processado.</p>`;
        return;
      }

      const rows = recordsToRows(data);

      preview.innerHTML = `
        <table>
          <thead>
            <tr>${HEADERS.map((h) => `<th>${h}</th>`).join("")}</tr>
          </thead>
          <tbody>
            ${rows
              .map((row) => `<tr>${row.map((c) => `<td>${c}</td>`).join("")}</tr>`)
              .join("")}
          </tbody>
        </table>`;
    }

    // ------------------------ XLSX BUILD ------------------------

    function chunkRecords(list, size) {
      const out = [];
      for (let i = 0; i < list.length; i += size)
        out.push(list.slice(i, i + size));
      return out;
    }

    function columnLetter(n) {
      let s = "";
      while (n > 0) {
        const r = (n - 1) % 26;
        s = String.fromCharCode(65 + r) + s;
        n = Math.floor((n - 1) / 26);
      }
      return s;
    }

    function rowsForBlocks(blocks, headers) {
      if (!blocks.length) return [headers];

      const max = Math.max(...blocks.map((b) => b.length));
      const rows = [];

      const headerRow = [];
      blocks.forEach((_, i) => {
        headerRow.push(...headers);
        if (i < blocks.length - 1) headerRow.push("");
      });

      rows.push(headerRow);

      for (let i = 0; i < max; i++) {
        const row = [];

        blocks.forEach((block, idx) => {
          if (i < block.length) {
            const r = block[i];
            row.push(
              sharepointTimestamp(r),
              r.company,
              "ELK",
              "Tela de despacho",
              "Sistemas",
              observation(r)
            );
          } else {
            row.push(...headers.map(() => ""));
          }

          if (idx < blocks.length - 1) row.push("");
        });

        rows.push(row);
      }

      return rows;
    }

    function escapeXml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&apos;");
    }

    function sheetXml(rows) {
      const out = [];

      rows.forEach((row, r) => {
        const cells = [];

        row.forEach((value, c) => {
          if (!value) return;

          const coord = `${columnLetter(c + 1)}${r + 1}`;
          cells.push(
            `<c r="${coord}" t="inlineStr"><is><t>${escapeXml(
              value
            )}</t></is></c>`
          );
        });

        if (cells.length)
          out.push(`<row r="${r + 1}">${cells.join("")}</row>`);
      });

      return (
        `<?xml version="1.0" encoding="UTF-8"?>` +
        `<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">` +
        `<sheetData>${out.join("")}</sheetData>` +
        `</worksheet>`
      );
    }

    function contentTypesXml() {
      return (
        `<?xml version="1.0" encoding="UTF-8"?>` +
        `<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">` +
        `<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>` +
        `<Default Extension="xml" ContentType="application/xml"/>` +
        `<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>` +
        `<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>` +
        `<Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>` +
        `</Types>`
      );
    }

    function relsXml() {
      return (
        `<?xml version="1.0" encoding="UTF-8"?>` +
        `<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">` +
        `<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>` +
        `</Relationships>`
      );
    }

    function workbookRelsXml() {
      return (
        `<?xml version="1.0" encoding="UTF-8"?>` +
        `<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">` +
        `<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>` +
        `<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>` +
        `</Relationships>`
      );
    }

    function workbookXml() {
      return (
        `<?xml version="1.0" encoding="UTF-8"?>` +
        `<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">` +
        `<sheets><sheet name="Despachos" sheetId="1" r:id="rId1"/></sheets>` +
        `</workbook>`
      );
    }

    function stylesXml() {
      return (
        `<?xml version="1.0" encoding="UTF-8"?>` +
        `<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">` +
        `<fonts count="1"><font/></fonts>` +
        `<fills count="1"><fill/></fills>` +
        `<borders count="1"><border/></borders>` +
        `<cellStyleXfs count="1"><xf/></cellStyleXfs>` +
        `<cellXfs count="1"><xf xfId="0"/></cellXfs>` +
        `</styleSheet>`
      );
    }

    // ------------------------ ZIP BUILD ------------------------

    function crc32(bytes) {
      const table = new Uint32Array(256);

      // gera tabela
      for (let i = 0; i < 256; i++) {
        let c = i;
        for (let k = 0; k < 8; k++) {
          c = c & 1 ? 0xedb88320 ^ (c >>> 1) : c >>> 1;
        }
        table[i] = c >>> 0;
      }

      let crc = 0xffffffff;

      for (let i = 0; i < bytes.length; i++) {
        crc = table[(crc ^ bytes[i]) & 0xff] ^ (crc >>> 8);
      }

      return (crc ^ 0xffffffff) >>> 0;
    }

    function encodeUtf8(text) {
      if (window.TextEncoder) return new TextEncoder().encode(text);

      const res = [];

      for (let i = 0; i < text.length; i++) {
        const code = text.charCodeAt(i);

        if (code < 0x80) {
          res.push(code);
        } else if (code < 0x800) {
          res.push(0xc0 | (code >> 6), 0x80 | (code & 0x3f));
        } else {
          res.push(
            0xe0 | (code >> 12),
            0x80 | ((code >> 6) & 0x3f),
            0x80 | (code & 0x3f)
          );
        }
      }

      return new Uint8Array(res);
    }

    function concatUint8(arrays) {
      const total = arrays.reduce((sum, a) => sum + a.length, 0);
      const out = new Uint8Array(total);

      let offset = 0;
      arrays.forEach((arr) => {
        out.set(arr, offset);
        offset += arr.length;
      });

      return out;
    }

    function numberToBytes(v, count) {
      const arr = new Uint8Array(count);

      for (let i = 0; i < count; i++) arr[i] = (v >> (8 * i)) & 0xff;

      return arr;
    }

    function buildZip(files) {
      const localParts = [];
      const centralParts = [];

      let offset = 0;

      files.forEach(({ name, content }) => {
        const nameBytes = encodeUtf8(name);
        const dataBytes = encodeUtf8(content);
        const crc = crc32(dataBytes);

        const header = concatUint8([
          numberToBytes(0x04034b50, 4),
          numberToBytes(20, 2),
          numberToBytes(0, 2),
          numberToBytes(0, 2),
          numberToBytes(0, 2),
          numberToBytes(0, 2),
          numberToBytes(crc, 4),
          numberToBytes(dataBytes.length, 4),
          numberToBytes(dataBytes.length, 4),
          numberToBytes(nameBytes.length, 2),
          numberToBytes(0, 2),
          nameBytes,
        ]);

        const local = concatUint8([header, dataBytes]);
        localParts.push(local);

        const central = concatUint8([
          numberToBytes(0x02014b50, 4),
          numberToBytes(20, 2),
          numberToBytes(20, 2),
          numberToBytes(0, 2),
          numberToBytes(0, 2),
          numberToBytes(0, 2),
          numberToBytes(0, 2),
          numberToBytes(crc, 4),
          numberToBytes(dataBytes.length, 4),
          numberToBytes(dataBytes.length, 4),
          numberToBytes(nameBytes.length, 2),
          numberToBytes(0, 2),
          numberToBytes(0, 2),
          numberToBytes(0, 2),
          numberToBytes(0, 2),
          numberToBytes(0, 4),
          numberToBytes(offset, 4),
          nameBytes,
        ]);

        centralParts.push(central);
        offset += local.length;
      });

      const centralDir = concatUint8(centralParts);

      const end = concatUint8([
        numberToBytes(0x06054b50, 4),
        numberToBytes(0, 2),
        numberToBytes(0, 2),
        numberToBytes(files.length, 2),
        numberToBytes(files.length, 2),
        numberToBytes(centralDir.length, 4),
        numberToBytes(offset, 4),
        numberToBytes(0, 2),
      ]);

      const blob = new Blob(
        [concatUint8([...localParts, centralDir, end])],
        { type: "application/zip" }
      );

      return blob;
    }

    function buildXlsxBlob(rows) {
      return buildZip([
        { name: "[Content_Types].xml", content: contentTypesXml() },
        { name: "_rels/.rels", content: relsXml() },
        { name: "xl/_rels/workbook.xml.rels", content: workbookRelsXml() },
        { name: "xl/workbook.xml", content: workbookXml() },
        { name: "xl/styles.xml", content: stylesXml() },
        { name: "xl/worksheets/sheet1.xml", content: sheetXml(rows) },
      ]);
    }

    function downloadExcel(data) {
      const blocks = chunkRecords(data, MAX_PER_BLOCK);
      const rows = rowsForBlocks(blocks, HEADERS);

      const blob = buildXlsxBlob(rows);
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "registros_despacho.xlsx";
      a.click();

      URL.revokeObjectURL(url);
    }

    // ------------------------ BUTTON EVENTS ------------------------

    themeSelect.addEventListener("change", (event) => {
      applyTheme(event.target.value);
    });

    loadTheme();

    btnLimpar.addEventListener("click", () => {
      const linhas = document.getElementById("linhas");

      linhas.value = "";
      erro.textContent = "";
      resumo.textContent = "";
      preview.innerHTML = "";
      registros = [];
      btnBaixar.disabled = true;
      btnCopiar.disabled = true;

      linhas.focus();
    });

    btnProcessar.addEventListener("click", () => {
      erro.textContent = "";
      resumo.textContent = "";
      preview.innerHTML = "";
      registros = [];
      shiftDateLabel = "";

      try {
        const allLines = document.getElementById("linhas").value.split(/\r?\n/);

        const { shiftDate, remainingLines } = extractShiftDate(allLines);
        registros = buildRecords(remainingLines, shiftDate);
        shiftDateLabel = formatShiftDate(shiftDate);

        renderPreview(registros);

        resumo.textContent = `${registros.length} registro(s) processado(s).`;
        btnBaixar.disabled = registros.length === 0;
        btnCopiar.disabled = registros.length === 0;
      } catch (e) {
        erro.textContent = e.message;
        btnBaixar.disabled = true;
        btnCopiar.disabled = true;
      }
    });

    btnBaixar.addEventListener("click", () => {
      if (!registros.length) return;

      try {
        downloadExcel(registros);
      } catch (e) {
        erro.textContent = `Falha ao gerar Excel: ${e.message}`;
      }
    });

    btnCopiar.addEventListener("click", async () => {
      if (!registros.length) return;

      erro.textContent = "";

      try {
        const lines = recordsToFormattedLines(registros);

        // data principal no topo
        const header = shiftDateLabel ? `${shiftDateLabel}\n\n` : "";
        const textToCopy = header + lines.join("\n");

        await copyText(textToCopy);
      } catch (e) {
        erro.textContent = e.message || "Falha ao copiar lista.";
      }
    });
  </script>
</body>
</html>
